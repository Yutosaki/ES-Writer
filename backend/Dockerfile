# Goの公式イメージをベースにする
FROM golang:latest

# ARGを宣言
ARG COGNITO_REGION
ARG COGNITO_CLIENT_ID
ARG TOKEN_KEY_URL
ARG GOOGLE_API_KEY
ARG DB_HOST
ARG DB_USER
ARG DB_PASSWORD
ARG DB_NAME
ARG DB_PORT

# 環境変数として設定
ENV COGNITO_REGION=$COGNITO_REGION
ENV COGNITO_CLIENT_ID=$COGNITO_CLIENT_ID
ENV TOKEN_KEY_URL=$TOKEN_KEY_URL
ENV GOOGLE_API_KEY=$GOOGLE_API_KEY
ENV DB_HOST=$DB_HOST
ENV DB_USER=$DB_USER
ENV DB_PASSWORD=$DB_PASSWORD
ENV DB_NAME=$DB_NAME
ENV DB_PORT=$DB_PORT

# 作業ディレクトリを設定
WORKDIR /app

# Goのモジュールを有効にする
ENV GO111MODULE=on

# 必要なGoのパッケージをダウンロード
COPY go.mod go.sum ./
RUN go mod download

# ソースコードをコピー
COPY . .

# APIサーバーをビルド
RUN go build -o main .

# ポート8080を公開
EXPOSE 8080

# APIサーバーを実行
CMD ["./main"]